pipeline
{
    agent any

    stages
    {
        stage ('Pull artifacts from github repository')
        {
            steps
            {
                git branch: 'main', url: 'https://github.com/AWSRJ/ec2_maven_02'
            }
        }

        stage ('Clean the previous build')
        {
            steps
            {
                withMaven(jdk: 'java_home', maven: 'maven_home')
                {
                    sh "mvn clean"
                }
            }
        }

        stage ('Compile the artifacts')
        {
            steps
            {
                withMaven(jdk: 'java_home', maven: 'maven_home')
                {
                    sh "mvn compile"
                }
            }
        }

        stage ('Test the artifacts')
        {
            steps
            {
                withMaven(jdk: 'java_home', maven: 'maven_home')
                {
                    sh "mvn test"
                }
            }
        }

        stage ('Build the package')
        {
            steps
            {
                withMaven(jdk: 'java_home', maven: 'maven_home')
                {
                    sh "mvn package"
                }
            }
        }

        stage ('Check application file')
        {
            environment
            {
                appl_file = fileExists '/var/lib/jenkins/workspace/Maven_HelloWorld_Project/target/MavenHelloWorldProject-1.0-SNAPSHOT.jar'
            }
            stages
            {
                stage('Execute application file if exists')
                {
                    when { expression { appl_file == 'true' } }
                    steps
                    {
                        sh 'java -cp target/MavenHelloWorldProject-1.0-SNAPSHOT.jar com.example.maven.App > index.html'
                    }
                }
                stage('Notify if application file do not exists')
                {
                    when { expression { appl_file == 'false' } }
                    steps
                    {
                        sh 'echo Application file MavenHelloWorldProject-1.0-SNAPSHOT.jar not found > index.html'
                    }
                }
            }
        }

        stage ('Deploy the package to tomcat server private IP 172.31.52.131')
        {
            steps
            {
                sshagent(credentials: ['cicd_pipeline_Jenkins_to_Tomcat'])
                {
                    sh 'scp -o StrictHostKeyChecking=no /var/lib/jenkins/workspace/Maven_HelloWorld_Pipeline_01/index.html ec2-user@172.31.52.131:/var/lib/tomcat/webapps/myapp'
                }
            }
        }

        stage ('Verification of code deployment on tomcat server')
        {
            steps
            {
                script
                {
                    def remote = [name: 'tomcat', host: '172.31.52.131', user: 'ec2-user', allowAnyHosts: true]
                    sshCommand remote: remote, command: "echo /var/lib/tomcat/webapps/myapp/index.html > a1.txt"
                }
            }
        }
    }
}
