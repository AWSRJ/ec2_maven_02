pipeline
{
    agent any

    stages
    {
        stage ('Pull artifacts from github repository')
        {
            steps
            {
                git branch: 'main', url: 'https://github.com/AWSRJ/ec2_maven_02'
            }
        }

        stage ('Clean the previous build')
        {
            steps
            {
                withMaven(jdk: 'java_home', maven: 'maven_home')
                {
                    sh "mvn clean"
                }
            }
        }

        stage ('Compile the artifacts')
        {
            steps
            {
                withMaven(jdk: 'java_home', maven: 'maven_home')
                {
                    sh "mvn compile"
                }
            }
        }

        stage ('Test the artifacts')
        {
            steps
            {
                withMaven(jdk: 'java_home', maven: 'maven_home')
                {
                    sh "mvn test"
                }
            }
        }

        stage ('Build the package')
        {
            steps
            {
                withMaven(jdk: 'java_home', maven: 'maven_home')
                {
                    sh "mvn package"
                }
            }
        }

        stage ('Deploy the package to tomcat server private IP 172.31.52.131')
        {
            steps
            {
                sshagent(credentials: ['cicd_pipeline_Jenkins_to_Tomcat'])
                {
                    sh 'scp -o StrictHostKeyChecking=no /var/lib/jenkins/workspace/Maven_HelloWorld_Pipeline_01/target/*.jar ec2-user@172.31.52.131:/var/lib/tomcat/webapps'
                }
            }
        }

        stage ('Check the file on tomcat server private IP 172.31.52.131')
        {
            steps
            {
                sshagent(credentials: ['cicd_pipeline_Jenkins_to_Tomcat'])
                {
                    def file_exists = fileExists '/var/lib/tomcat/webapps/MavenHelloWorldProject-1.0-SNAPSHOT.jar'
                    if (file_exists)
                    {
                        echo 'File exists'
                    }
                    else
                    {
                        echo 'File not found'
                    }
                }
            }
        }
    }
}
